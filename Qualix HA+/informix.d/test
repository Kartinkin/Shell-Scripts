#!/usr/xpg4/bin/sh
# Version	2.1q
# Date		09 Aug 2000
# Author	Kirill Kartinkin

# Программа для проверки работоспособности кластерного сервиса,
# представленного СУБД INFORMIX. Результаты проверки основываются на наличии
# процессов СУБД и мнении команды onstat.
#
# Работа программы гарантирована с СУБД версий 7.xx.
# Доподлинно известно, что она не поддерживает INFORMIX старше версии 7.
#
# Администратор СУБД Informix -- пользователь informix:informix.
# Программу требуется запускать от имени пользователя root.
#
# Внимание! Данная программа работает только совместно с Qualix и только в
# рамках группы сервисов.
#
# Внимание! Программа не способна обрабатывать уменьшение числа виртуальных
# процессоров СУБД. Данное административное действие приравнивается к сбою в
# работе СУБД и фиксируеся ошибка.
#
# Параметры:
#	нет
#
# Возвращаемые значения:
#	0	O.K.
#	1	Одного из процессов СУБД INFORMIX нет
#	2	Команда onstat говорит, что СУБД не в режиме online
#	101	Ошибка подключения вспомогательных файлов
#

# Если эти переменные не описаны, значит нас запустили "руками"
if [[ -z ${TOPDIR} || -z ${SGNAME} || -z ${SVCNAME} ]]
then
	# Ошибка, переменные не описаны
	exit 100
fi

################################################################################
# Описываем переменные конфигурации и производим необходимые проверки

# Переменная TOPDIR задает месторасположение Qualix HA+,
# например, /etc/opt/QUALha.
# Переменная SGNAME содержит имя сервисной группы
# Переменная SVCNAME содержит имя сервиса
 
# Устанавливаем необходимые пути поиска
PATH=/sbin:/usr/sbin:/usr/xpg4/bin:/usr/bin:/var/adm/bin

# Извлекаем из командной строки имя программы
Name=${SGNAME}.${SVCNAME}.${0##*/}

# Домашняя директория администратора СУБД
InformixHome=~informix

# Внимание! Для работы программы необходимы следующие файлы:
set -A FilesToSource \
	"loadenv.ksh <${InformixHome}/.${SGNAME}.environment" \
	${TOPDIR}/sg/${SGNAME}/${SVCNAME}.d/environment \
	/var/adm/bin/logger.sh
	
# В файле ~informix/.${SGNAME}.environment содержатся все необходимые
# администратору СУБД переменные окружения.
#	INFORMIXDIR
#	INFORMIXSERVER
#	ONCONFIG
#
# В файле /${SGDir}/${SVCNAME}.d/environment содержатся
# переменные окружения для пакета.
#	PIDsFile
#	SGFacility
#
# Файле /var/adm/bin/logger.sh содержит функцию Logger
# Следующие переменные необходимы для описания этой функции.
# При описании используем одинарные кавычки, чтобы передать имя переменной
# окружения, а не ее значение.
LOGGER_FACILITY=${SGFacility}
LOGGER_TAG=${SGNAME}

# Добавляем указанные выше файлы
for File in ${FilesToSource[*]}
do
	if [[ -f ${File} ]]
	then
		. ${File}
	else
		print "${Name}:\tERROR: Unnable to source ${File}"
		exit 101
	fi
done

################################################################################
################################################################################
# Проверяем работу СУБД INFORMIX
# Сначала смотрим, все ли процессы на месте, потом пробуем onstat.

# Считываем список pid'ов процессов, созданный для нас при старте.
MonitorProcessesPIDs=$(cat ${PIDsFile})

# Проходим по всем процессам
for pid in ${MonitorProcessesPIDs}
do
	# В теле цикла проверяется наличие в системе процесса
	kill -0 ${pid} >/dev/null 2>&1
	if (( $? != 0 ))
	then
		# Процесса не обнаружено
		Logger err "Process \"${pid}\" has failed!"
		# Сохраняем список процессов
		ps -el
		exit 1
	fi
done

# Используем onstat для определения режима работы СУБД
OnStatOut=$(su informix -c "${INFORMIXDIR}/bin/onstat -")
# Ищем в выводе программы слово On-Line
print "${OnStatOut}" | grep "On-Line" >/dev/null 2>&1
if (( $? !=0 ))
then
	# Не нашли -- плохо
	Logger err "INFORMIX ODS is not in On-Line mode!"
	exit 2
fi

# Все проверки пройдены
exit 0
